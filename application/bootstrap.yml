- name: Bootstrapping the appliation layer of the cluster
  hosts: localhost
  tasks:
    - name: Wait for ArgoCD to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: argocd-server
        namespace: argocd
      register: argocd_deployment
      until: argocd_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Apply application ApplicationSet
      kubernetes.core.k8s:
        src: argocd/applicationsets/application.yaml
        state: present
        server_side_apply:
          field_manager: argocd-controller

    - name: Apply prive ApplicationSet
      kubernetes.core.k8s:
        src: argocd/applicationsets/application-prive.yaml
        state: present
        server_side_apply:
          field_manager: argocd-controller